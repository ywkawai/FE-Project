

!-------------------------------------------------------------------------------
! Warning: This file was generated from fluid_dyn_solver/scale_atm_dyn_dgm_hevi_common_linalgebra.F90.erb.
!          Do not edit this file.
!-------------------------------------------------------------------------------
!-------------------------------------------------------------------------------
!> module FElib / Fluid dyn solver / Atmosphere / HEVI / Common
!!
!! @par Description
!!      Computational kernels associated with linear algebra for vertical implicit solvers
!!
!! @author Yuta Kawai, Xuanzhengbo Ren, and Team SCALE
!<
!-------------------------------------------------------------------------------
#include "scaleFElib.h"
module scale_atm_dyn_dgm_hevi_common_linalgebra
  !-----------------------------------------------------------------------------
  !
  !++ Used modules
  !
  use scale_precision
  use scale_io
  use scale_prc
  use scale_prof  
  !-----------------------------------------------------------------------------
  implicit none
  private
  !-----------------------------------------------------------------------------
  !
  !++ Public procedures
  !
  public :: atm_dyn_dgm_hevi_common_linalgebra_get_param
  public :: atm_dyn_dgm_hevi_common_linalgebra_solve_uv
  public :: atm_dyn_dgm_hevi_common_linalgebra_solve_var3

  !-----------------------------------------------------------------------------
  !
  !++ Public parameters & variables
  !
  
  !-----------------------------------------------------------------------------
  !
  !++ Private procedures & variables
  !
  !-------------------
contains
!OCL SERIAL
  subroutine atm_dyn_dgm_hevi_common_linalgebra_get_param( im, jm, Nnode_h1D )
    implicit none
    integer, intent(out) :: im
    integer, intent(out) :: jm
    integer, intent(in) :: Nnode_h1D
    !-----------------------------------------------------------
    select case(Nnode_h1D)
    case( 2 )
      im = 4
    case( 3 )
      im = 9
    case( 4 )
      im = 16
    case( 5 )
      im = 5
    case( 6 )
      im = 6
    case( 7 )
      im = 7
    case( 8 )
      im = 8
    case( 9 )
      im = 9
    case( 10 )
      im = 10
    case( 11 )
      im = 22
    case( 12 )
      im = 24
    case( 13 )
      im = 26
    case( 14 )
      im = 28
    case( 15 )
      im = 15
    case( 16 )
      im = 16
    end select
    jm = Nnode_h1D**2/im

    return
  end subroutine atm_dyn_dgm_hevi_common_linalgebra_get_param

!OCL SERIAL
  subroutine atm_dyn_dgm_hevi_common_linalgebra_solve_uv( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: im, jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(im,Nnode_v,Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: b(im,Nnode_v,2,jm,Ne2D)
    real(RP), intent(inout) :: G(im,Nnode_v,jm,Ne2D)
    logical, intent(in) :: is_top
    !------------------------------------------
    select case(Nnode_v)
    case( 2 )
      if ( im == 4 ) then
        call solve_Nnode2_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 3 )
      if ( im == 9 ) then
        call solve_Nnode3_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 4 )
      if ( im == 16 ) then
        call solve_Nnode4_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 5 )
      if ( im == 5 ) then
        call solve_Nnode5_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 6 )
      if ( im == 6 ) then
        call solve_Nnode6_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 7 )
      if ( im == 7 ) then
        call solve_Nnode7_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 8 )
      if ( im == 8 ) then
        call solve_Nnode8_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 9 )
      if ( im == 9 ) then
        call solve_Nnode9_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 10 )
      if ( im == 10 ) then
        call solve_Nnode10_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 11 )
      if ( im == 22 ) then
        call solve_Nnode11_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 12 )
      if ( im == 24 ) then
        call solve_Nnode12_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 13 )
      if ( im == 26 ) then
        call solve_Nnode13_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 14 )
      if ( im == 28 ) then
        call solve_Nnode14_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 15 )
      if ( im == 15 ) then
        call solve_Nnode15_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case( 16 )
      if ( im == 16 ) then
        call solve_Nnode16_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
      else
        call solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
      end if
    case default
      LOG_INFO('atm_dyn_dgm_hevi_common_linalgebra_solve_uv',*) "im > 16 is not supported. Check!"
      call PRC_abort
    end select
    return
  end subroutine atm_dyn_dgm_hevi_common_linalgebra_solve_uv

!OCL SERIAL
  subroutine atm_dyn_dgm_hevi_common_linalgebra_solve_var3( D, b, G, Nnode_v, im, jm, Ne2D, is_top)
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: im, jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(im,3*Nnode_v,3*Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: b(im,3*Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: G(im,3*Nnode_v,3,jm,Ne2D)
    logical, intent(in) :: is_top
    !------------------------------------------
    select case(Nnode_v)
      case( 2 )
        if ( im == 4 ) then
          call solve_Nnode2_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 3 )
        if ( im == 9 ) then
          call solve_Nnode3_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 4 )
        if ( im == 16 ) then
          call solve_Nnode4_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 5 )
        if ( im == 5 ) then
          call solve_Nnode5_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 6 )
        if ( im == 6 ) then
          call solve_Nnode6_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 7 )
        if ( im == 7 ) then
          call solve_Nnode7_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 8 )
        if ( im == 8 ) then
          call solve_Nnode8_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 9 )
        if ( im == 9 ) then
          call solve_Nnode9_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 10 )
        if ( im == 10 ) then
          call solve_Nnode10_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 11 )
        if ( im == 22 ) then
          call solve_Nnode11_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 12 )
        if ( im == 24 ) then
          call solve_Nnode12_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 13 )
        if ( im == 26 ) then
          call solve_Nnode13_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 14 )
        if ( im == 28 ) then
          call solve_Nnode14_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 15 )
        if ( im == 15 ) then
          call solve_Nnode15_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case( 16 )
        if ( im == 16 ) then
          call solve_Nnode16_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
        else
          call solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
        end if
      case default
        LOG_INFO('atm_dyn_dgm_hevi_common_linalgebra_solve',*) "im > 16 is not supported. Check!"
        call PRC_abort
    end select
    return
  end subroutine atm_dyn_dgm_hevi_common_linalgebra_solve_var3

!------
!OCL SERIAL
  subroutine solve_Nnode2_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(4,2,2,jm,Ne2D)
    real(RP), intent(inout) :: b(4,2,2,jm,Ne2D)
    real(RP), intent(inout) :: G(4,2,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(4,2)
    real(RP) :: tmpv(4)
    real(RP) :: tmpv2(4)
    real(RP) :: A(4,2,2)
    real(RP) :: bb(4,3,2)
    real(RP) :: tmpb(4,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 2
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 2
          do v=1, 4
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 4
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 2
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 2
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 2      
          do i=k+1, 2
            do v=1, 4
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 2-1
          do v=1, 4
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 2
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=2, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 2
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 2-1
          do v=1, 4
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 2
          do v=1,4
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 2
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=2, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 2
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 2
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode2_uv
!OCL SERIAL
  subroutine solve_Nnode2_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(4,6,6,jm,Ne2D)
    real(RP), intent(inout) :: b(4,6,jm,Ne2D)
    real(RP), intent(inout) :: G(4,6,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(4,6)
    real(RP) :: tmpv(4)
    real(RP) :: A(4,6,6)
    real(RP) :: bb(4,4,6)
    real(RP) :: tmpb(4,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 6
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 6
          do v=1, 4
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 4
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 6
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 6
          do v=1, 4
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 6      
          do i=k+1, 6
            do v=1, 4
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 6-1
          do v=1, 4
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 6
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=6, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 6
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 6-1
          do v=1, 4
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 6
          do v=1,4
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 6
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=6, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 6
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 6
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode2_var3  
!OCL SERIAL
  subroutine solve_Nnode3_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(9,3,3,jm,Ne2D)
    real(RP), intent(inout) :: b(9,3,2,jm,Ne2D)
    real(RP), intent(inout) :: G(9,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(9,3)
    real(RP) :: tmpv(9)
    real(RP) :: tmpv2(9)
    real(RP) :: A(9,3,3)
    real(RP) :: bb(9,3,3)
    real(RP) :: tmpb(9,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 3
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 3
          do v=1, 9
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 9
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 3
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 3
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 3      
          do i=k+1, 3
            do v=1, 9
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 3-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 3
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=3, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 3
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 3-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 3
          do v=1,9
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 3
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=3, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 3
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 3
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode3_uv
!OCL SERIAL
  subroutine solve_Nnode3_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(9,9,9,jm,Ne2D)
    real(RP), intent(inout) :: b(9,9,jm,Ne2D)
    real(RP), intent(inout) :: G(9,9,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(9,9)
    real(RP) :: tmpv(9)
    real(RP) :: A(9,9,9)
    real(RP) :: bb(9,4,9)
    real(RP) :: tmpb(9,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 9
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 9
          do v=1, 9
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 9
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 9
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 9
          do v=1, 9
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 9      
          do i=k+1, 9
            do v=1, 9
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 9-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 9
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=9, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 9
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 9-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 9
          do v=1,9
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 9
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=9, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 9
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 9
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode3_var3  
!OCL SERIAL
  subroutine solve_Nnode4_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(16,4,4,jm,Ne2D)
    real(RP), intent(inout) :: b(16,4,2,jm,Ne2D)
    real(RP), intent(inout) :: G(16,4,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(16,4)
    real(RP) :: tmpv(16)
    real(RP) :: tmpv2(16)
    real(RP) :: A(16,4,4)
    real(RP) :: bb(16,3,4)
    real(RP) :: tmpb(16,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 4
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 4
          do v=1, 16
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 16
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 4
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 4
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 4      
          do i=k+1, 4
            do v=1, 16
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 4-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 4
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=4, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 4
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 4-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 4
          do v=1,16
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 4
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=4, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 4
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 4
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode4_uv
!OCL SERIAL
  subroutine solve_Nnode4_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(16,12,12,jm,Ne2D)
    real(RP), intent(inout) :: b(16,12,jm,Ne2D)
    real(RP), intent(inout) :: G(16,12,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(16,12)
    real(RP) :: tmpv(16)
    real(RP) :: A(16,12,12)
    real(RP) :: bb(16,4,12)
    real(RP) :: tmpb(16,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 12
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 12
          do v=1, 16
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 16
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 12
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 12
          do v=1, 16
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 12      
          do i=k+1, 12
            do v=1, 16
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 12-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 12
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=12, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 12
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 12-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 12
          do v=1,16
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 12
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=12, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 12
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 12
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode4_var3  
!OCL SERIAL
  subroutine solve_Nnode5_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(5,5,5,jm,Ne2D)
    real(RP), intent(inout) :: b(5,5,2,jm,Ne2D)
    real(RP), intent(inout) :: G(5,5,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(5,5)
    real(RP) :: tmpv(5)
    real(RP) :: tmpv2(5)
    real(RP) :: A(5,5,5)
    real(RP) :: bb(5,3,5)
    real(RP) :: tmpb(5,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 5
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 5
          do v=1, 5
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 5
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 5
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 5
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 5      
          do i=k+1, 5
            do v=1, 5
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 5-1
          do v=1, 5
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 5
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=5, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 5
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 5-1
          do v=1, 5
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 5
          do v=1,5
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 5
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=5, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 5
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 5
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode5_uv
!OCL SERIAL
  subroutine solve_Nnode5_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(5,15,15,jm,Ne2D)
    real(RP), intent(inout) :: b(5,15,jm,Ne2D)
    real(RP), intent(inout) :: G(5,15,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(5,15)
    real(RP) :: tmpv(5)
    real(RP) :: A(5,15,15)
    real(RP) :: bb(5,4,15)
    real(RP) :: tmpb(5,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 15
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 15
          do v=1, 5
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 5
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 15
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 15
          do v=1, 5
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 15      
          do i=k+1, 15
            do v=1, 5
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 15-1
          do v=1, 5
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 15
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=15, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 15
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 15-1
          do v=1, 5
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 15
          do v=1,5
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 15
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=15, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 15
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 15
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode5_var3  
!OCL SERIAL
  subroutine solve_Nnode6_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(6,6,6,jm,Ne2D)
    real(RP), intent(inout) :: b(6,6,2,jm,Ne2D)
    real(RP), intent(inout) :: G(6,6,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(6,6)
    real(RP) :: tmpv(6)
    real(RP) :: tmpv2(6)
    real(RP) :: A(6,6,6)
    real(RP) :: bb(6,3,6)
    real(RP) :: tmpb(6,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 6
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 6
          do v=1, 6
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 6
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 6
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 6
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 6      
          do i=k+1, 6
            do v=1, 6
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 6-1
          do v=1, 6
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 6
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=6, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 6
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 6-1
          do v=1, 6
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 6
          do v=1,6
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 6
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=6, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 6
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 6
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode6_uv
!OCL SERIAL
  subroutine solve_Nnode6_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(6,18,18,jm,Ne2D)
    real(RP), intent(inout) :: b(6,18,jm,Ne2D)
    real(RP), intent(inout) :: G(6,18,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(6,18)
    real(RP) :: tmpv(6)
    real(RP) :: A(6,18,18)
    real(RP) :: bb(6,4,18)
    real(RP) :: tmpb(6,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 18
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 18
          do v=1, 6
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 6
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 18
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 18
          do v=1, 6
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 18      
          do i=k+1, 18
            do v=1, 6
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 18-1
          do v=1, 6
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 18
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=18, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 18
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 18-1
          do v=1, 6
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 18
          do v=1,6
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 18
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=18, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 18
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 18
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode6_var3  
!OCL SERIAL
  subroutine solve_Nnode7_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(7,7,7,jm,Ne2D)
    real(RP), intent(inout) :: b(7,7,2,jm,Ne2D)
    real(RP), intent(inout) :: G(7,7,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(7,7)
    real(RP) :: tmpv(7)
    real(RP) :: tmpv2(7)
    real(RP) :: A(7,7,7)
    real(RP) :: bb(7,3,7)
    real(RP) :: tmpb(7,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 7
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 7
          do v=1, 7
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 7
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 7
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 7
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 7      
          do i=k+1, 7
            do v=1, 7
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 7-1
          do v=1, 7
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 7
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=7, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 7
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 7-1
          do v=1, 7
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 7
          do v=1,7
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 7
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=7, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 7
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 7
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode7_uv
!OCL SERIAL
  subroutine solve_Nnode7_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(7,21,21,jm,Ne2D)
    real(RP), intent(inout) :: b(7,21,jm,Ne2D)
    real(RP), intent(inout) :: G(7,21,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(7,21)
    real(RP) :: tmpv(7)
    real(RP) :: A(7,21,21)
    real(RP) :: bb(7,4,21)
    real(RP) :: tmpb(7,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 21
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 21
          do v=1, 7
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 7
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 21
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 21
          do v=1, 7
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 21      
          do i=k+1, 21
            do v=1, 7
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 21-1
          do v=1, 7
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 21
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=21, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 21
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 21-1
          do v=1, 7
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 21
          do v=1,7
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 21
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=21, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 21
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 21
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode7_var3  
!OCL SERIAL
  subroutine solve_Nnode8_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(8,8,8,jm,Ne2D)
    real(RP), intent(inout) :: b(8,8,2,jm,Ne2D)
    real(RP), intent(inout) :: G(8,8,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(8,8)
    real(RP) :: tmpv(8)
    real(RP) :: tmpv2(8)
    real(RP) :: A(8,8,8)
    real(RP) :: bb(8,3,8)
    real(RP) :: tmpb(8,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 8
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 8
          do v=1, 8
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 8
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 8
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 8
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 8      
          do i=k+1, 8
            do v=1, 8
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 8-1
          do v=1, 8
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 8
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=8, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 8
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 8-1
          do v=1, 8
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 8
          do v=1,8
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 8
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=8, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 8
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 8
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode8_uv
!OCL SERIAL
  subroutine solve_Nnode8_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(8,24,24,jm,Ne2D)
    real(RP), intent(inout) :: b(8,24,jm,Ne2D)
    real(RP), intent(inout) :: G(8,24,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(8,24)
    real(RP) :: tmpv(8)
    real(RP) :: A(8,24,24)
    real(RP) :: bb(8,4,24)
    real(RP) :: tmpb(8,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 24
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 24
          do v=1, 8
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 8
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 24
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 24
          do v=1, 8
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 24      
          do i=k+1, 24
            do v=1, 8
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 24-1
          do v=1, 8
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 24
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=24, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 24
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 24-1
          do v=1, 8
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 24
          do v=1,8
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 24
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=24, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 24
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 24
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode8_var3  
!OCL SERIAL
  subroutine solve_Nnode9_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(9,9,9,jm,Ne2D)
    real(RP), intent(inout) :: b(9,9,2,jm,Ne2D)
    real(RP), intent(inout) :: G(9,9,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(9,9)
    real(RP) :: tmpv(9)
    real(RP) :: tmpv2(9)
    real(RP) :: A(9,9,9)
    real(RP) :: bb(9,3,9)
    real(RP) :: tmpb(9,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 9
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 9
          do v=1, 9
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 9
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 9
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 9
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 9      
          do i=k+1, 9
            do v=1, 9
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 9-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 9
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=9, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 9
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 9-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 9
          do v=1,9
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 9
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=9, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 9
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 9
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode9_uv
!OCL SERIAL
  subroutine solve_Nnode9_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(9,27,27,jm,Ne2D)
    real(RP), intent(inout) :: b(9,27,jm,Ne2D)
    real(RP), intent(inout) :: G(9,27,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(9,27)
    real(RP) :: tmpv(9)
    real(RP) :: A(9,27,27)
    real(RP) :: bb(9,4,27)
    real(RP) :: tmpb(9,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 27
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 27
          do v=1, 9
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 9
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 27
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 27
          do v=1, 9
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 27      
          do i=k+1, 27
            do v=1, 9
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 27-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 27
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=27, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 27
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 27-1
          do v=1, 9
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 27
          do v=1,9
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 27
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=27, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 27
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 27
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode9_var3  
!OCL SERIAL
  subroutine solve_Nnode10_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(10,10,10,jm,Ne2D)
    real(RP), intent(inout) :: b(10,10,2,jm,Ne2D)
    real(RP), intent(inout) :: G(10,10,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(10,10)
    real(RP) :: tmpv(10)
    real(RP) :: tmpv2(10)
    real(RP) :: A(10,10,10)
    real(RP) :: bb(10,3,10)
    real(RP) :: tmpb(10,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 10
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 10
          do v=1, 10
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 10
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 10
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 10
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 10      
          do i=k+1, 10
            do v=1, 10
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 10-1
          do v=1, 10
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 10
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=10, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 10
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 10-1
          do v=1, 10
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 10
          do v=1,10
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 10
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=10, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 10
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 10
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode10_uv
!OCL SERIAL
  subroutine solve_Nnode10_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(10,30,30,jm,Ne2D)
    real(RP), intent(inout) :: b(10,30,jm,Ne2D)
    real(RP), intent(inout) :: G(10,30,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(10,30)
    real(RP) :: tmpv(10)
    real(RP) :: A(10,30,30)
    real(RP) :: bb(10,4,30)
    real(RP) :: tmpb(10,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 30
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 30
          do v=1, 10
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 10
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 30
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 30
          do v=1, 10
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 30      
          do i=k+1, 30
            do v=1, 10
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 30-1
          do v=1, 10
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 30
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=30, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 30
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 30-1
          do v=1, 10
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 30
          do v=1,10
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 30
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=30, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 30
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 30
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode10_var3  
!OCL SERIAL
  subroutine solve_Nnode11_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(22,11,11,jm,Ne2D)
    real(RP), intent(inout) :: b(22,11,2,jm,Ne2D)
    real(RP), intent(inout) :: G(22,11,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(22,11)
    real(RP) :: tmpv(22)
    real(RP) :: tmpv2(22)
    real(RP) :: A(22,11,11)
    real(RP) :: bb(22,3,11)
    real(RP) :: tmpb(22,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 11
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 11
          do v=1, 22
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 22
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 11
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 11
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 11      
          do i=k+1, 11
            do v=1, 22
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 11-1
          do v=1, 22
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 11
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=11, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 11
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 11-1
          do v=1, 22
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 11
          do v=1,22
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 11
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=11, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 11
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 11
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode11_uv
!OCL SERIAL
  subroutine solve_Nnode11_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(22,33,33,jm,Ne2D)
    real(RP), intent(inout) :: b(22,33,jm,Ne2D)
    real(RP), intent(inout) :: G(22,33,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(22,33)
    real(RP) :: tmpv(22)
    real(RP) :: A(22,33,33)
    real(RP) :: bb(22,4,33)
    real(RP) :: tmpb(22,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 33
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 33
          do v=1, 22
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 22
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 33
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 33
          do v=1, 22
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 33      
          do i=k+1, 33
            do v=1, 22
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 33-1
          do v=1, 22
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 33
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=33, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 33
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 33-1
          do v=1, 22
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 33
          do v=1,22
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 33
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=33, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 33
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 33
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode11_var3  
!OCL SERIAL
  subroutine solve_Nnode12_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(24,12,12,jm,Ne2D)
    real(RP), intent(inout) :: b(24,12,2,jm,Ne2D)
    real(RP), intent(inout) :: G(24,12,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(24,12)
    real(RP) :: tmpv(24)
    real(RP) :: tmpv2(24)
    real(RP) :: A(24,12,12)
    real(RP) :: bb(24,3,12)
    real(RP) :: tmpb(24,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 12
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 12
          do v=1, 24
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 24
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 12
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 12
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 12      
          do i=k+1, 12
            do v=1, 24
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 12-1
          do v=1, 24
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 12
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=12, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 12
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 12-1
          do v=1, 24
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 12
          do v=1,24
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 12
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=12, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 12
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 12
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode12_uv
!OCL SERIAL
  subroutine solve_Nnode12_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(24,36,36,jm,Ne2D)
    real(RP), intent(inout) :: b(24,36,jm,Ne2D)
    real(RP), intent(inout) :: G(24,36,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(24,36)
    real(RP) :: tmpv(24)
    real(RP) :: A(24,36,36)
    real(RP) :: bb(24,4,36)
    real(RP) :: tmpb(24,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 36
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 36
          do v=1, 24
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 24
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 36
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 36
          do v=1, 24
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 36      
          do i=k+1, 36
            do v=1, 24
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 36-1
          do v=1, 24
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 36
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=36, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 36
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 36-1
          do v=1, 24
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 36
          do v=1,24
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 36
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=36, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 36
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 36
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode12_var3  
!OCL SERIAL
  subroutine solve_Nnode13_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(26,13,13,jm,Ne2D)
    real(RP), intent(inout) :: b(26,13,2,jm,Ne2D)
    real(RP), intent(inout) :: G(26,13,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(26,13)
    real(RP) :: tmpv(26)
    real(RP) :: tmpv2(26)
    real(RP) :: A(26,13,13)
    real(RP) :: bb(26,3,13)
    real(RP) :: tmpb(26,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 13
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 13
          do v=1, 26
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 26
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 13
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 13
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 13      
          do i=k+1, 13
            do v=1, 26
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 13-1
          do v=1, 26
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 13
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=13, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 13
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 13-1
          do v=1, 26
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 13
          do v=1,26
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 13
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=13, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 13
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 13
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode13_uv
!OCL SERIAL
  subroutine solve_Nnode13_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(26,39,39,jm,Ne2D)
    real(RP), intent(inout) :: b(26,39,jm,Ne2D)
    real(RP), intent(inout) :: G(26,39,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(26,39)
    real(RP) :: tmpv(26)
    real(RP) :: A(26,39,39)
    real(RP) :: bb(26,4,39)
    real(RP) :: tmpb(26,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 39
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 39
          do v=1, 26
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 26
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 39
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 39
          do v=1, 26
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 39      
          do i=k+1, 39
            do v=1, 26
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 39-1
          do v=1, 26
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 39
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=39, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 39
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 39-1
          do v=1, 26
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 39
          do v=1,26
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 39
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=39, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 39
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 39
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode13_var3  
!OCL SERIAL
  subroutine solve_Nnode14_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(28,14,14,jm,Ne2D)
    real(RP), intent(inout) :: b(28,14,2,jm,Ne2D)
    real(RP), intent(inout) :: G(28,14,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(28,14)
    real(RP) :: tmpv(28)
    real(RP) :: tmpv2(28)
    real(RP) :: A(28,14,14)
    real(RP) :: bb(28,3,14)
    real(RP) :: tmpb(28,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 14
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 14
          do v=1, 28
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 28
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 14
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 14
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 14      
          do i=k+1, 14
            do v=1, 28
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 14-1
          do v=1, 28
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 14
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=14, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 14
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 14-1
          do v=1, 28
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 14
          do v=1,28
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 14
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=14, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 14
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 14
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode14_uv
!OCL SERIAL
  subroutine solve_Nnode14_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(28,42,42,jm,Ne2D)
    real(RP), intent(inout) :: b(28,42,jm,Ne2D)
    real(RP), intent(inout) :: G(28,42,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(28,42)
    real(RP) :: tmpv(28)
    real(RP) :: A(28,42,42)
    real(RP) :: bb(28,4,42)
    real(RP) :: tmpb(28,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 42
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 42
          do v=1, 28
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 28
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 42
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 42
          do v=1, 28
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 42      
          do i=k+1, 42
            do v=1, 28
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 42-1
          do v=1, 28
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 42
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=42, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 42
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 42-1
          do v=1, 28
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 42
          do v=1,28
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 42
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=42, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 42
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 42
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode14_var3  
!OCL SERIAL
  subroutine solve_Nnode15_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(15,15,15,jm,Ne2D)
    real(RP), intent(inout) :: b(15,15,2,jm,Ne2D)
    real(RP), intent(inout) :: G(15,15,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(15,15)
    real(RP) :: tmpv(15)
    real(RP) :: tmpv2(15)
    real(RP) :: A(15,15,15)
    real(RP) :: bb(15,3,15)
    real(RP) :: tmpb(15,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 15
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 15
          do v=1, 15
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 15
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 15
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 15
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 15      
          do i=k+1, 15
            do v=1, 15
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 15-1
          do v=1, 15
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 15
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=15, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 15
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 15-1
          do v=1, 15
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 15
          do v=1,15
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 15
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=15, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 15
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 15
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode15_uv
!OCL SERIAL
  subroutine solve_Nnode15_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(15,45,45,jm,Ne2D)
    real(RP), intent(inout) :: b(15,45,jm,Ne2D)
    real(RP), intent(inout) :: G(15,45,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(15,45)
    real(RP) :: tmpv(15)
    real(RP) :: A(15,45,45)
    real(RP) :: bb(15,4,45)
    real(RP) :: tmpb(15,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 45
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 45
          do v=1, 15
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 15
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 45
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 45
          do v=1, 15
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 45      
          do i=k+1, 45
            do v=1, 15
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 45-1
          do v=1, 15
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 45
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=45, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 45
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 45-1
          do v=1, 15
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 45
          do v=1,15
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 45
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=45, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 45
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 45
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode15_var3  
!OCL SERIAL
  subroutine solve_Nnode16_uv( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(16,16,16,jm,Ne2D)
    real(RP), intent(inout) :: b(16,16,2,jm,Ne2D)
    real(RP), intent(inout) :: G(16,16,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(16,16)
    real(RP) :: tmpv(16)
    real(RP) :: tmpv2(16)
    real(RP) :: A(16,16,16)
    real(RP) :: bb(16,3,16)
    real(RP) :: tmpb(16,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 16
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 16
          do v=1, 16
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 16
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 16
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 16
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, 16      
          do i=k+1, 16
            do v=1, 16
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 16-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 16
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=16, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, 16
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, 16-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 16
          do v=1,16
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, 16
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=16, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 16
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 16
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode16_uv
!OCL SERIAL
  subroutine solve_Nnode16_var3( D, b, G, Nnode_v, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(16,48,48,jm,Ne2D)
    real(RP), intent(inout) :: b(16,48,jm,Ne2D)
    real(RP), intent(inout) :: G(16,48,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(16,48)
    real(RP) :: tmpv(16)
    real(RP) :: A(16,48,48)
    real(RP) :: bb(16,4,48)
    real(RP) :: tmpb(16,4)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do collapse(2) private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, 48
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, 48
          do v=1, 16
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, 16
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, 48
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, 48
          do v=1, 16
            A(v,i,k) = A(v,i,k) * tmpv(v)
          end do
        end do
        do j=k+1, 48      
          do i=k+1, 48
            do v=1, 16
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, 48-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, 48
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=48, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, 48
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, 48-1
          do v=1, 16
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, 48
          do v=1,16
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, 48
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=48, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, 48
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, 48
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_Nnode16_var3  
!OCL SERIAL
  subroutine solve_uv_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: im, jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(im,Nnode_v,Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: b(im,Nnode_v,2,jm,Ne2D)
    real(RP), intent(inout) :: G(im,Nnode_v,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(im,Nnode_v)
    real(RP) :: tmpv(im)
    real(RP) :: tmpv2(im)
    real(RP) :: A(im,Nnode_v,Nnode_v)
    real(RP) :: bb(im,3,Nnode_v)
    real(RP) :: tmpb(im,3)
    real(RP) :: tmp
    !------------------------------

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpv2,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, Nnode_v
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, Nnode_v
          do v=1, im
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, im
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, Nnode_v
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, Nnode_v
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, Nnode_v     
          do i=k+1, Nnode_v
            do v=1, im
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, Nnode_v-1
          do v=1, im
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, Nnode_v
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=1, i-1
            tmpv (:) = tmpv (:) - b(:,j,1,v2,ke_xy) * A(:,i,j)
            tmpv2(:) = tmpv2(:) - b(:,j,2,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:)
          b(:,i,2,v2,ke_xy) = tmpv2(:)
        end do
        do i=Nnode_v, 1, -1
          tmpv (:) = b(:,i,1,v2,ke_xy)
          tmpv2(:) = b(:,i,2,v2,ke_xy)
          do j=i+1, Nnode_v
            tmpv (:) = tmpv (:) - A(:,i,j) * b(:,j,1,v2,ke_xy)
            tmpv2(:) = tmpv2(:) - A(:,i,j) * b(:,j,2,v2,ke_xy)
          end do
          b(:,i,1,v2,ke_xy) = tmpv (:) * A(:,i,i)
          b(:,i,2,v2,ke_xy) = tmpv2(:) * A(:,i,i)
        end do
      else
        do i=1, Nnode_v-1
          do v=1, im
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,1,v2,ke_xy)
              b(v,i,1,v2,ke_xy) = b(v,ip,1,v2,ke_xy)
              b(v,ip,1,v2,ke_xy) = tmp
              tmp = b(v,i,2,v2,ke_xy)
              b(v,i,2,v2,ke_xy) = b(v,ip,2,v2,ke_xy)
              b(v,ip,2,v2,ke_xy) = tmp

              tmp = G(v,i,v2,ke_xy)
              G(v,i,v2,ke_xy) = G(v,ip,v2,ke_xy)
              G(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, Nnode_v
          do v=1,im
            bb(v,1,i) = b(v,i,1,v2,ke_xy)
            bb(v,2,i) = b(v,i,2,v2,ke_xy)
            bb(v,3,i) = G(v,i,v2,ke_xy)
          end do
        end do
        do i=1, Nnode_v
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=Nnode_v, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, Nnode_v
            do r=1, 3
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 3
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, Nnode_v
          b(:,i,1,v2,ke_xy) = bb(:,1,i)
          b(:,i,2,v2,ke_xy) = bb(:,2,i)
          G(:,i,v2,ke_xy) = bb(:,3,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_uv_im

!OCL SERIAL
  subroutine solve_var3_im( D, b, G, Nnode_v, im, jm, Ne2D, is_top )
    implicit none
    integer, intent(in) :: Nnode_v
    integer, intent(in) :: im, jm
    integer, intent(in) :: Ne2D
    real(RP), intent(in) :: D(im,3*Nnode_v,3*Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: b(im,3*Nnode_v,jm,Ne2D)
    real(RP), intent(inout) :: G(im,3*Nnode_v,3,jm,Ne2D)
    logical, intent(in) :: is_top

    integer :: ke_xy
    integer :: v2
    integer :: k, i, j, v, r
    integer :: ip
    integer :: ipiv(im,3*Nnode_v)
    real(RP) :: tmpv(im)
    real(RP) :: A(im,3*Nnode_v,3*Nnode_v)
    real(RP) :: bb(im,4,3*Nnode_v)
    real(RP) :: tmpb(im,4)
    real(RP) :: tmp
    integer :: Nnode_vx3
    !------------------------------

    Nnode_vx3 = Nnode_v * 3

    !$omp parallel do private(ke_xy,v2,k,i,j,v,r,ip,ipiv,tmpv,tmpb,tmp,bb,A) collapse(2)
    do ke_xy=1, Ne2D
    do v2=1, jm
      A(:,:,:) = D(:,:,:,v2,ke_xy)
      do k=1, Nnode_vx3
        tmpv(:) = abs(A(:,k,k))
        ipiv(:,k) = k
        do i=k+1, Nnode_vx3
          do v=1, im
            tmp = abs(A(v,i,k)) 
            if (  tmp > tmpv(v) ) then
              ipiv(v,k) = i
              tmpv(v) = tmp
            end if
          end do
        end do
        do v=1, im
          ip = ipiv(v,k) 
          if ( ip /= k ) then
            do j=1, Nnode_vx3
              tmp = A(v,k,j)
              A(v,k,j) = A(v,ip,j)
              A(v,ip,j) = tmp
          end do
          end if
        end do
        !--
        tmpv(:) = 1.0_RP / A(:,k,k)
        A(:,k,k) = tmpv(:)      
        do i=k+1, Nnode_vx3
          A(:,i,k) = A(:,i,k) * tmpv(:)
        end do
        do j=k+1, Nnode_vx3
          do i=k+1, Nnode_vx3
            do v=1, im
              A(v,i,j) = A(v,i,j) - A(v,i,k) * A(v,k,j)
            end do
          end do
        end do
      end do
      !---------------------------
      if ( is_top ) then
        do i=1, Nnode_vx3-1
          do v=1, im
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp
            end if
          end do
        end do
        do i=1, Nnode_vx3
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=1, i-1
            tmpv(:) = tmpv(:) - b(:,j,v2,ke_xy) * A(:,i,j)
          end do
          b(:,i,v2,ke_xy) = tmpv(:)
        end do
        do i=Nnode_vx3, 1, -1
          tmpv(:) = b(:,i,v2,ke_xy)
          do j=i+1, Nnode_vx3
            tmpv(:) = tmpv(:) - A(:,i,j) * b(:,j,v2,ke_xy)
          end do
          b(:,i,v2,ke_xy) = tmpv(:) * A(:,i,i)
        end do
      else
        do i=1, Nnode_vx3-1
          do v=1, im
            ip = ipiv(v,i)
            if (ip /= i) then
              tmp = b(v,i,v2,ke_xy)
              b(v,i,v2,ke_xy) = b(v,ip,v2,ke_xy)
              b(v,ip,v2,ke_xy) = tmp

              tmp = G(v,i,1,v2,ke_xy)
              G(v,i,1,v2,ke_xy) = G(v,ip,1,v2,ke_xy)
              G(v,ip,1,v2,ke_xy) = tmp
              tmp = G(v,i,2,v2,ke_xy)
              G(v,i,2,v2,ke_xy) = G(v,ip,2,v2,ke_xy)
              G(v,ip,2,v2,ke_xy) = tmp
              tmp = G(v,i,3,v2,ke_xy)
              G(v,i,3,v2,ke_xy) = G(v,ip,3,v2,ke_xy)
              G(v,ip,3,v2,ke_xy) = tmp
            end if
          end do
        end do        
        do i=1, Nnode_vx3
          do v=1, im
            bb(v,1,i) = b(v,i,v2,ke_xy)
            bb(v,2,i) = G(v,i,1,v2,ke_xy)
            bb(v,3,i) = G(v,i,2,v2,ke_xy)
            bb(v,4,i) = G(v,i,3,v2,ke_xy)
          end do
        end do
        do i=1, Nnode_vx3
          tmpb(:,:) = bb(:,:,i)
          do j=1, i-1
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - bb(:,r,j) * A(:,i,j)
            end do
          end do
          bb(:,:,i) = tmpb(:,:)
        end do
        do i=Nnode_vx3, 1, -1
          tmpb(:,:) = bb(:,:,i)
          do j=i+1, Nnode_vx3
            do r=1, 4
              tmpb(:,r) = tmpb(:,r) - A(:,i,j) * bb(:,r,j)
            end do
          end do
          do r=1, 4
            bb(:,r,i) = tmpb(:,r) * A(:,i,i)
          end do
        end do
        do i=1, Nnode_vx3
          b(:,i,v2,ke_xy) = bb(:,1,i)
          G(:,i,1,v2,ke_xy) = bb(:,2,i)
          G(:,i,2,v2,ke_xy) = bb(:,3,i)
          G(:,i,3,v2,ke_xy) = bb(:,4,i)
        end do
      end if
    end do
    end do
    return
  end subroutine solve_var3_im  

end module scale_atm_dyn_dgm_hevi_common_linalgebra
